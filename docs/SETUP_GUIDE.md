# Windows Setup Guide

This document provides complete steps and solutions for successfully compiling and running this project on Windows (including Chinese locale systems).

## System Requirements

- Windows 10/11
- Node.js (v18 or higher recommended)
- Git

## Required Build Tools

### 1. Visual Studio Build Tools 2022

**Installation Steps:**

1. Download [Visual Studio Build Tools 2022](https://visualstudio.microsoft.com/downloads/#build-tools-for-visual-studio-2022)

2. Run the installer and select the following components:
   - **✅ C++ build tools** (workload)
   - **✅ MSVC v143 - VS 2022 C++ x64/x86 build tools** (latest version)
   - **✅ Windows 10/11 SDK** (latest version)
   - **✅ MSVC v143 - VS 2022 C++ x64/x86 Spectre-mitigated libs** (latest version) ⚠️ **Important**

3. Restart command prompt after installation

### 2. Python Environment

Ensure Python 3.x is installed (required by node-gyp):
```bash
python --version
```

## Build Steps

### 1. Clone and Prepare Project

```bash
git clone <repository-url>
cd claudecodeui
```

### 2. Install Dependencies (Skip Build Scripts)

Some native modules have compilation issues on Chinese Windows systems, so skip build scripts first:

```bash
npm install --ignore-scripts
```

### 3. Manually Compile Native Modules

Compile each native module in order:

```bash
# Compile SQLite-related modules
npm rebuild better-sqlite3
npm rebuild sqlite3
npm rebuild bcrypt
```

### 4. Fix node-pty Compilation Issues

node-pty encounters character encoding issues on Chinese Windows systems and needs manual fixing:

#### 4.1 Create Version File

```bash
# Enter winpty directory
cd node_modules/node-pty/deps/winpty/src

# Create gen directory
mkdir gen

# Get current git commit hash
git rev-parse HEAD
```

#### 4.2 Modify winpty.gyp File

Edit `node_modules/node-pty/deps/winpty/src/winpty.gyp`:

**Before:**
```gyp
'WINPTY_COMMIT_HASH%': '<!(cmd /c "cd shared && GetCommitHash.bat")',
```

**After:**
```gyp
'WINPTY_COMMIT_HASH%': '06bb5feb091aa6ae23b12c5d9d07f408a08d24d0',
```
*(Replace with actual commit hash)*

**Before:**
```gyp
'include_dirs': [
    '<!(cmd /c "cd shared && UpdateGenVersion.bat <(WINPTY_COMMIT_HASH)")',
],
```

**After:**
```gyp
'include_dirs': [
    'gen',
],
```

#### 4.3 Create Version Header File

Create `node_modules/node-pty/deps/winpty/src/gen/GenVersion.h`:

```cpp
// AUTO-GENERATED BY UpdateGenVersion.bat
const char GenVersion_Version[] = "0.4.4-dev";
const char GenVersion_Commit[] = "06bb5feb091aa6ae23b12c5d9d07f408a08d24d0";
```

#### 4.4 Compile node-pty

```bash
npm rebuild node-pty
```

### 5. Test Build Results

#### Frontend Build Test
```bash
npm run build
```

#### Backend Server Test
```bash
npm run server
```

#### Full Development Environment Test
```bash
npm run dev
```

## Common Issues and Solutions

### Issue 1: `missing any VC++ toolset`

**Solution:**
Ensure "MSVC v143 - VS 2022 C++ x64/x86 build tools" is installed in Visual Studio Installer

### Issue 2: `Spectre-mitigated libraries required`

**Solution:**
In Visual Studio Installer, go to "Individual components" tab and install:
- MSVC v143 - VS 2022 C++ x64/x86 Spectre-mitigated libs (Latest)

### Issue 3: Garbled characters in GetCommitHash.bat

**Solution:**
This is a character encoding issue on Chinese Windows systems. Follow step 4 above to fix node-pty.

### Issue 4: `EADDRINUSE: address already in use`

**Solution:**
```bash
# Release occupied ports
npx kill-port 3001
npx kill-port 5173
```

### Issue 5: PowerShell Execution Policy Error

**Error Message:**
```
Cannot load file claude.ps1 because script execution is disabled on this system.
```

**Automatic Fix:**
This issue is automatically fixed in the project! The UI automatically uses `cmd /c "claude"` wrapper to bypass PowerShell execution policy restrictions.

**Manual Solutions (if needed):**

**Method 1: Set Permanent Execution Policy (Recommended)**
```bash
cmd /c "reg add HKCU\SOFTWARE\Microsoft\PowerShell\1\ShellIds\Microsoft.PowerShell /v ExecutionPolicy /t REG_SZ /d RemoteSigned /f"
```

**Method 2: Use Bypass Parameter Each Time**
```powershell
powershell -ExecutionPolicy Bypass -File "C:\Users\%USERNAME%\AppData\Roaming\npm\claude.ps1"
```

**Method 3: One-time Setting in PowerShell Session**
```powershell
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process
```

**Verify Fix:**
```bash
claude --version
```
Should display something like: `1.0.113 (Claude Code)`

## Running Commands

### Development Mode (Frontend + Backend)
```bash
npm run dev
```
- Frontend: http://localhost:5173
- Backend: http://0.0.0.0:3001

### Backend Only
```bash
npm run server
```

### Frontend Only
```bash
npm run client
```

### Production Build
```bash
npm run build
npm start
```

## Important Notes

1. **When reinstalling dependencies**: If you run `npm install`, you may need to reapply the node-pty fix steps

2. **Environment variables**: Ensure Visual Studio Build Tools path is in system PATH

3. **Permission issues**: Some steps may require administrator privileges

4. **Character encoding**: Chinese Windows systems may encounter encoding issues when compiling certain C++ modules - this is normal

## Verify Installation

After successful installation, you should see:

```
Connected to SQLite database
Database initialized successfully
Claude Code UI server running on http://0.0.0.0:3001

VITE v7.1.5  ready in XXX ms
➜  Local:   http://localhost:5173/
➜  Network: http://192.168.1.XXX:5173/
```

## Technical Details

This project includes the following native modules:
- **better-sqlite3**: SQLite database (primary)
- **sqlite3**: SQLite database (fallback)
- **bcrypt**: Password encryption
- **node-pty**: Pseudo-terminal support (for terminal functionality)

All modules require a C++ compiler and related toolchain to build correctly.

## Public Access Setup (ngrok)

If you need external devices (like phones or other networks) to access the local development server, you can use ngrok:

### 1. Install ngrok

1. Go to [ngrok website](https://ngrok.com/) and register an account
2. Download ngrok and extract to system PATH
3. Get your authtoken from ngrok dashboard

### 2. Configure ngrok

Copy `ngrok.yml.example` to `ngrok.yml` and edit:

```yaml
authtoken: YOUR_NGROK_AUTH_TOKEN_HERE  # Replace with your authtoken
region: us  # Choose nearest region: us, eu, ap, au, sa, jp, in
```

### 3. Start Services

**Method 1: Using Config File**
```bash
# First start dev server
npm run dev

# In a new terminal, start ngrok
ngrok start claude-ui --config ngrok.yml
```

**Method 2: Simple Command**
```bash
# First start dev server
npm run dev

# Expose port 5173 directly
ngrok http 5173
```

### 4. Access Instructions

After ngrok starts, it will display:
```
Forwarding  https://abc123.ngrok.io -> http://localhost:5173
```

- Copy the `https://abc123.ngrok.io` link
- Open the link in any device's browser
- All features work normally (including terminal and WebSocket)

### 5. Security Notes

- **Production warning**: ngrok links may be accessible by anyone
- You can set basic authentication in `ngrok.yml`:
  ```yaml
  auth: "username:password"
  ```
- IP whitelisting can be configured for access restriction
- Free version links change periodically; paid version supports fixed subdomains

### 6. Troubleshooting

**Issue: WebSocket connection failed**
- Confirm ngrok config includes WebSocket support
- Check browser console for SSL certificate warnings

**Issue: API requests failed**
- Confirm only frontend port 5173 is exposed (don't expose 3001 simultaneously)
- Vite proxy automatically forwards API requests to backend
