---
phase: 03-ui-size-indicators
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/projects.js
  - src/components/Sidebar.jsx
autonomous: true

must_haves:
  truths:
    - "Session items display file size next to timestamp"
    - "Size is formatted using KB/MB/GB with 1 decimal place"
    - "Size only displays when value is available and > 0"
  artifacts:
    - path: "server/projects.js"
      provides: "Session objects with sizeBytes field"
      contains: "sizeBytes"
    - path: "src/components/Sidebar.jsx"
      provides: "Session size display in list items"
      contains: "session.sizeBytes"
  key_links:
    - from: "getSessions in server/projects.js"
      to: "session.sizeBytes"
      via: "fs.stat size passed through to session object"
      pattern: "sizeBytes.*stats\\.size|size.*sizeBytes"
    - from: "Sidebar.jsx session display"
      to: "formatBytes(session.sizeBytes)"
      via: "inline text after formatTimeAgo"
      pattern: "formatBytes.*session\\.sizeBytes"
---

<objective>
Display individual session file sizes in the sidebar session list

Purpose: Users can see which sessions are large before opening them, completing the size visibility feature set. Project total size is already displayed; this adds per-session granularity.

Output: Session items show file size (e.g., "2 mins ago 1.2 MB") in both mobile and desktop views
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ui-size-indicators/03-RESEARCH.md

# Key files
@server/projects.js (getSessions function around line 782, parseJsonlSessions around line 922)
@src/components/Sidebar.jsx (formatBytes at line 21, session display at lines 1216-1225 mobile, 1277-1286 desktop)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sizeBytes to session objects in getSessions</name>
  <files>server/projects.js</files>
  <action>
Modify the `getSessions` function to include file size in session objects:

1. In `getSessions` (around line 802-808), update the file stat mapping to include size:
   ```javascript
   const filesWithStats = await Promise.all(
     jsonlFiles.map(async (file) => {
       const filePath = path.join(projectDir, file);
       const stats = await fs.stat(filePath);
       return { file, mtime: stats.mtime, size: stats.size };
     })
   );
   ```

2. Pass the file size through to `parseJsonlSessions`. Update the call (around line 822):
   ```javascript
   const result = await parseJsonlSessions(jsonlFile, MAX_ENTRIES_PER_FILE, mtime, size);
   ```
   Note: Each file may contain multiple sessions. Since we want per-session visibility, we'll attach the file size to each session from that file. This is an approximation (sessions share file), but provides useful size indication.

3. Update `parseJsonlSessions` signature (around line 922) to accept file size:
   ```javascript
   async function parseJsonlSessions(filePath, maxEntries = null, fileMtime = null, fileSize = null) {
   ```

4. In `parseJsonlSessions`, when creating session objects (around line 949-958), add sizeBytes:
   ```javascript
   sessions.set(entry.sessionId, {
     id: entry.sessionId,
     summary: 'New Session',
     messageCount: 0,
     lastActivity: fileMtime || new Date(),
     cwd: entry.cwd || '',
     lastUserMessage: null,
     lastAssistantMessage: null,
     timestampSource: fileMtime ? 'mtime' : 'fallback',
     sizeBytes: fileSize || 0  // Add this line
   });
   ```

Note: Multiple sessions in one file will share the same sizeBytes. This is acceptable since the primary goal is visibility of large files, not precise per-session accounting.
  </action>
  <verify>
Run the server and check API response:
```bash
curl -s http://localhost:3001/api/projects/SOME_PROJECT/sessions | jq '.sessions[0] | {id, sizeBytes}'
```
Should return session object with sizeBytes field (number > 0 for non-empty files).
  </verify>
  <done>Session objects from /api/projects/:name/sessions include sizeBytes field with file size in bytes</done>
</task>

<task type="auto">
  <name>Task 2: Display session file size in Sidebar</name>
  <files>src/components/Sidebar.jsx</files>
  <action>
Add size display to session items in both mobile and desktop views:

1. **Mobile session display** (around lines 1216-1225):
   After the timestamp span, add size display:
   ```jsx
   <div className="flex items-center gap-1 mt-0.5">
     <Clock className="w-2.5 h-2.5 text-muted-foreground" />
     <span className="text-xs text-muted-foreground">
       {formatTimeAgo(sessionTime, currentTime, t)}
     </span>
     {session.sizeBytes > 0 && (
       <span className="text-xs text-muted-foreground opacity-60">
         {formatBytes(session.sizeBytes)}
       </span>
     )}
     {messageCount > 0 && (
       // ... existing badge code
     )}
   ```

2. **Desktop session display** (around lines 1277-1286):
   Same pattern - add size after timestamp:
   ```jsx
   <div className="flex items-center gap-1 mt-0.5">
     <Clock className="w-2.5 h-2.5 text-muted-foreground" />
     <span className="text-xs text-muted-foreground">
       {formatTimeAgo(sessionTime, currentTime, t)}
     </span>
     {session.sizeBytes > 0 && (
       <span className="text-xs text-muted-foreground opacity-60">
         {formatBytes(session.sizeBytes)}
       </span>
     )}
     {messageCount > 0 && (
       // ... existing badge code
     )}
   ```

The pattern matches existing project size display: `text-xs text-muted-foreground opacity-60` for reduced visual weight. The `formatBytes` function already exists at line 21.

Note: Check that the conditional `session.sizeBytes > 0` handles undefined/null gracefully (falsy check should work).
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Open browser to http://localhost:3000
3. Expand a project with sessions
4. Verify each session shows: "[time ago] [size]" (e.g., "2 mins ago 1.2 MB")
5. Check both mobile (narrow viewport) and desktop views
  </verify>
  <done>Session items display file size in KB/MB/GB format after the timestamp in both mobile and desktop views</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. API returns sizeBytes: `curl -s localhost:3001/api/projects/[PROJECT]/sessions | jq '.sessions[] | {id: .id, sizeBytes: .sizeBytes}'`
2. UI displays sizes: Visual check that session items show size after timestamp
3. Formatting correct: Sizes use KB/MB/GB with 1 decimal (e.g., "1.2 MB" not "1234567 bytes")
4. No display for zero/missing: Sessions with sizeBytes=0 or undefined don't show size text
</verification>

<success_criteria>
- Session items in sidebar display file size next to timestamp (UI-02 complete)
- Size formatted as KB/MB/GB with 1 decimal place (UI-03 already complete via formatBytes)
- Display works in both mobile and desktop views
- No visual regressions in session list appearance
</success_criteria>

<output>
After completion, create `.planning/phases/03-ui-size-indicators/03-01-SUMMARY.md`
</output>
