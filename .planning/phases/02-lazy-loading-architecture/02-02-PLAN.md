---
phase: 02-lazy-loading-architecture
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - server/index.js
  - src/components/Sidebar.jsx
autonomous: true

must_haves:
  truths:
    - "GET /api/projects returns minimal project data without sessions"
    - "Sidebar fetches sessions when project is expanded"
    - "Session count and size visible on project cards before expansion"
    - "Expanding project triggers API call to load sessions"
  artifacts:
    - path: "server/index.js"
      provides: "Updated /api/projects endpoint using getProjectsMinimal"
      contains: "getProjectsMinimal"
    - path: "src/components/Sidebar.jsx"
      provides: "Lazy loading sessions on project expansion"
      contains: "loadSessionsForProject"
  key_links:
    - from: "server/index.js:/api/projects"
      to: "server/projects.js:getProjectsMinimal"
      via: "function call"
      pattern: "getProjectsMinimal\\("
    - from: "src/components/Sidebar.jsx:toggleProject"
      to: "/api/projects/:projectName/sessions"
      via: "fetch when expanded"
      pattern: "api\\.sessions\\("
---

<objective>
Integrate lazy loading into API and frontend

Purpose: Connect the minimal project metadata function to the API and update the Sidebar to fetch sessions on-demand when projects are expanded
Output: `/api/projects` returns minimal data, Sidebar fetches sessions only when user expands a project
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-lazy-loading-architecture/02-CONTEXT.md
@.planning/phases/02-lazy-loading-architecture/02-RESEARCH.md
@.planning/phases/02-lazy-loading-architecture/02-01-SUMMARY.md
@server/index.js
@src/components/Sidebar.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update /api/projects endpoint to use getProjectsMinimal</name>
  <files>server/index.js</files>
  <action>
Update the `/api/projects` endpoint (around line 389) to use `getProjectsMinimal` instead of `getProjects`:

1. Import `getProjectsMinimal` from `./projects.js` (add to existing import on line 60)
2. Change the `/api/projects` handler to call `getProjectsMinimal(broadcastProgress)` instead of `getProjects(broadcastProgress)`

The existing `/api/projects/:projectName/sessions` endpoint (line 398) already exists and works, so no changes needed there.

Before:
```javascript
app.get('/api/projects', authenticateToken, async (req, res) => {
    try {
        const projects = await getProjects(broadcastProgress);
        res.json(projects);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});
```

After:
```javascript
app.get('/api/projects', authenticateToken, async (req, res) => {
    try {
        const projects = await getProjectsMinimal(broadcastProgress);
        res.json(projects);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});
```

Also update the file watcher (around line 146) to use `getProjectsMinimal` instead of `getProjects` for the same reason.
  </action>
  <verify>
Start server and call: `curl -s http://localhost:3001/api/projects | jq '.[0] | {name, sessionCount, totalSizeBytes, sessions: (.sessions | length)}'`
Should show sessionCount > 0 and sessions array length = 0
  </verify>
  <done>
`/api/projects` endpoint returns minimal project data with sessionCount and totalSizeBytes but empty sessions array. File watcher also uses getProjectsMinimal.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Sidebar to fetch sessions on project expansion</name>
  <files>src/components/Sidebar.jsx</files>
  <action>
Modify the Sidebar component to fetch sessions when a project is expanded:

1. Add a new state to track which projects have had their sessions loaded:
```javascript
const [loadedProjectSessions, setLoadedProjectSessions] = useState({});
```

2. Create a `loadSessionsForProject` function that:
   - Checks if sessions are already loaded for the project
   - If not, fetches from `/api/projects/:projectName/sessions` via `api.sessions()`
   - Stores the result in `loadedProjectSessions` state

3. Update `toggleProject` function to:
   - Call `loadSessionsForProject(project)` when expanding a project
   - Only if `project.sessions.length === 0 && !loadedProjectSessions[project.name]`

4. Update `getAllSessions` helper (around line 226) to merge:
   - `project.sessions` (from initial load - now empty)
   - `loadedProjectSessions[project.name]?.sessions` (from on-demand fetch)
   - `additionalSessions[project.name]` (from "show more" loads)

5. Update the "Show More Sessions" button logic to work with the new loaded sessions.

Key: The existing `loadMoreSessions` function (line 413) already fetches from the sessions endpoint. The new `loadSessionsForProject` should do the initial fetch, and `loadMoreSessions` handles pagination after that.

Show a loading indicator while sessions are being fetched (reuse the existing loading skeleton pattern from lines 1038-1050).
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Open browser, observe projects load quickly without sessions
3. Click a project to expand - should see loading indicator then sessions appear
4. Network tab should show `/api/projects` returns minimal data, then `/api/projects/:name/sessions` called on expansion
  </verify>
  <done>
Sidebar fetches sessions only when project is expanded. Initial project list loads quickly. Expanding a project shows loading state then populates sessions from API.
  </done>
</task>

<task type="auto">
  <name>Task 3: Display session count and size on collapsed project cards</name>
  <files>src/components/Sidebar.jsx</files>
  <action>
Update the project card display to show session count and optionally size:

1. The session count display already exists (around line 796-799), but verify it uses `project.sessionCount` from the minimal API response (not calculated from sessions array length)

2. Add optional size display under the session count:
```jsx
<p className="text-xs text-muted-foreground">
  {project.sessionCount} session{project.sessionCount === 1 ? '' : 's'}
  {project.totalSizeBytes > 0 && (
    <span className="ml-1 opacity-60">
      • {formatBytes(project.totalSizeBytes)}
    </span>
  )}
</p>
```

3. Add a `formatBytes` helper function at the top of the file (or import from a utils file):
```javascript
const formatBytes = (bytes) => {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
};
```

4. Update the mobile project card view similarly (around line 795-800).

5. Update the desktop project view (around line 941-944) to show the same info.

This gives users visibility into project size before they expand it, which is part of Phase 3 success criteria but natural to add here since we have the data.
  </action>
  <verify>
1. View Sidebar in browser
2. Collapsed projects should show "X sessions • Y MB" format
3. Size should be human-readable (KB, MB, GB as appropriate)
  </verify>
  <done>
Project cards display session count and total size from minimal API response. Users can see project size without expanding it.
  </done>
</task>

</tasks>

<verification>
1. Start the server: `npm run dev`
2. Open browser to the app
3. Verify initial project list loads quickly (should be noticeably faster than before)
4. Verify projects show session count and size
5. Verify clicking a project shows loading state then loads sessions
6. Check Network tab:
   - `/api/projects` response should have empty `sessions` arrays
   - `/api/projects/:name/sessions` should be called when expanding
7. Verify "Show More Sessions" still works after initial load
</verification>

<success_criteria>
- Initial `/api/projects` call returns minimal data (no sessions)
- Project cards show session count and total size before expansion
- Expanding a project triggers sessions API call
- Sessions load and display correctly after expansion
- "Show More Sessions" pagination still works
- No regression in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/02-lazy-loading-architecture/02-02-SUMMARY.md`
</output>
