---
phase: 02-lazy-loading-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/projects.js
autonomous: true

must_haves:
  truths:
    - "getProjectsMinimal returns projects without parsing JSONL content"
    - "Session count derived from JSONL file count in directory"
    - "Total size computed from fs.stat without reading file content"
    - "Last activity timestamp from most recent file mtime"
  artifacts:
    - path: "server/projects.js"
      provides: "getProjectsMinimal function for lazy loading"
      exports: ["getProjectsMinimal"]
  key_links:
    - from: "server/projects.js:getProjectsMinimal"
      to: "fs.readdir with withFileTypes"
      via: "directory listing without file parsing"
      pattern: "readdir.*withFileTypes.*true"
---

<objective>
Create server-side function for minimal project metadata extraction

Purpose: Enable instant project list loading by extracting metadata from filesystem stats rather than JSONL content parsing
Output: New `getProjectsMinimal()` function that returns session count, total size, and last activity from filesystem metadata only
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-lazy-loading-architecture/02-CONTEXT.md
@.planning/phases/02-lazy-loading-architecture/02-RESEARCH.md
@server/projects.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create getProjectsMinimal function</name>
  <files>server/projects.js</files>
  <action>
Add a new `getProjectsMinimal()` function to server/projects.js that:

1. Scans `~/.claude/projects/` directory using `fs.readdir` with `{ withFileTypes: true }`
2. For each project directory, computes metadata from filesystem WITHOUT opening JSONL files:
   - `sessionCount`: Count of `.jsonl` files (excluding `agent-*.jsonl`)
   - `totalSizeBytes`: Sum of file sizes from `fs.stat` on each JSONL file
   - `lastActivity`: Most recent `mtime` from JSONL files
3. Still uses existing `extractProjectDirectory()` for getting project path (already byte-limited from Phase 1)
4. Still uses existing `generateDisplayName()` for display name
5. Returns projects array with these fields:
   - `name`, `path`, `displayName`, `fullPath`, `isCustomName`
   - `sessionCount`, `totalSizeBytes`, `lastActivity`
   - `sessions: []` (empty - will be loaded separately)
   - `cursorSessions: []`, `codexSessions: []` (empty - will be loaded separately)
   - `incompleteMetadata` flag if cwd came from fallback

Key patterns from RESEARCH.md:
- Use `readdir(projectDir, { withFileTypes: true })` to avoid redundant stat calls
- Filter JSONL files with `e.isFile() && e.name.endsWith('.jsonl') && !e.name.startsWith('agent-')`
- Use `fs.stat` to get size and mtime without reading content
- Skip patterns and size limits still apply (use existing `getProjectSkipReason`)

Do NOT modify existing `getProjects()` - add new function alongside it.
Export the new function.
  </action>
  <verify>
Run: `node -e "import('./server/projects.js').then(m => console.log('getProjectsMinimal exported:', typeof m.getProjectsMinimal === 'function'))"`
Should output: "getProjectsMinimal exported: true"
  </verify>
  <done>
`getProjectsMinimal` function exists and is exported from server/projects.js. Function computes session count, total size, and last activity from filesystem metadata without parsing JSONL content.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add getSessionFilesMetadata helper</name>
  <files>server/projects.js</files>
  <action>
Add a helper function `getSessionFilesMetadata(projectDir)` that:

1. Accepts a project directory path
2. Uses `fs.readdir` with `{ withFileTypes: true }` to list files
3. Filters to `.jsonl` files excluding `agent-*.jsonl`
4. Calls `fs.stat` on each file to get size and mtime
5. Returns object:
   ```javascript
   {
     sessionCount: number,
     totalSizeBytes: number,
     lastActivity: Date | null,
     files: Array<{ filename: string, size: number, mtime: Date }>
   }
   ```

Use batched stat operations if there are many files (50 at a time) per RESEARCH.md pitfall on EMFILE.

This helper will be used by both `getProjectsMinimal()` and potentially a future sessions-by-filename endpoint.
  </action>
  <verify>
Run: `node -e "import('./server/projects.js').then(m => console.log('getSessionFilesMetadata exported:', typeof m.getSessionFilesMetadata === 'function'))"`
Should output: "getSessionFilesMetadata exported: true"
  </verify>
  <done>
`getSessionFilesMetadata` helper function exists and is exported. Returns session count, total size, last activity, and file list from filesystem metadata only.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add manual tests for metadata extraction</name>
  <files>server/projects.js</files>
  <action>
Create a simple test block at the bottom of projects.js (before exports) that can be run with `node server/projects.js --test`:

```javascript
// Self-test when run directly
if (process.argv.includes('--test')) {
  (async () => {
    console.log('Testing getProjectsMinimal...');
    const start = Date.now();
    const projects = await getProjectsMinimal();
    const duration = Date.now() - start;

    console.log(`Found ${projects.length} projects in ${duration}ms`);

    // Verify structure
    if (projects.length > 0) {
      const p = projects[0];
      const hasRequired = 'sessionCount' in p && 'totalSizeBytes' in p && 'lastActivity' in p;
      console.log('Has required fields:', hasRequired);
      console.log('Sample project:', JSON.stringify({
        name: p.name,
        sessionCount: p.sessionCount,
        totalSizeBytes: p.totalSizeBytes,
        lastActivity: p.lastActivity,
        sessions: p.sessions?.length ?? 'undefined'
      }, null, 2));
    }

    console.log('Test complete!');
  })();
}
```

This allows quick verification that the function works without starting the full server.
  </action>
  <verify>
Run: `node server/projects.js --test`
Should output project count, duration, and sample project with sessionCount, totalSizeBytes, lastActivity fields
  </verify>
  <done>
Self-test block added. Running `node server/projects.js --test` outputs project list with metadata fields proving filesystem-only extraction works.
  </done>
</task>

</tasks>

<verification>
1. `getProjectsMinimal` is exported from server/projects.js
2. `getSessionFilesMetadata` is exported from server/projects.js
3. Running `node server/projects.js --test` shows:
   - Projects found with session counts
   - Duration is fast (< 500ms for typical project set)
   - Sample project has `sessionCount`, `totalSizeBytes`, `lastActivity` fields
   - Sample project has empty `sessions: []` array
</verification>

<success_criteria>
- getProjectsMinimal function extracts session count, total size, last activity from filesystem metadata
- No JSONL file content is read during getProjectsMinimal execution
- Skip patterns and size limits still work
- Function returns same project structure as getProjects minus populated sessions
- Self-test demonstrates working implementation
</success_criteria>

<output>
After completion, create `.planning/phases/02-lazy-loading-architecture/02-01-SUMMARY.md`
</output>
