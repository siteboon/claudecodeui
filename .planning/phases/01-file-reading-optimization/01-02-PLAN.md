---
phase: 01-file-reading-optimization
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - server/projects.js
autonomous: true

must_haves:
  truths:
    - "extractProjectDirectory() uses byte-limited reading (100KB max)"
    - "extractProjectDirectory() falls back to folder name when cwd not found in 100KB"
    - "Existing skip patterns (SKIP_PROJECTS_PATTERN, SKIP_LARGE_PROJECTS_MB) still work"
    - "API response structure unchanged (backward compatible)"
  artifacts:
    - path: "server/projects.js"
      provides: "Updated extractProjectDirectory with byte-limited reading"
      exports: ["extractProjectDirectory", "extractCwdFromFirstBytes"]
  key_links:
    - from: "extractProjectDirectory"
      to: "extractCwdFromFirstBytes"
      via: "function call for each JSONL file"
      pattern: "extractCwdFromFirstBytes\\("
    - from: "extractProjectDirectory"
      to: "loadProjectConfig"
      via: "config lookup before file reading (preserved)"
      pattern: "loadProjectConfig\\(\\)"
---

<objective>
Integrate byte-limited cwd extraction into extractProjectDirectory() and add proper fallback behavior when cwd cannot be found within the byte limit.

Purpose: This wires the memory-safe extraction into the actual project discovery flow, ensuring large projects can be loaded without crashing while gracefully handling edge cases.

Output: Updated extractProjectDirectory() that uses byte-limited reading and graceful fallbacks.
</objective>

<execution_context>
@/home/node/.claude/get-shit-done/workflows/execute-plan.md
@/home/node/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-file-reading-optimization/01-RESEARCH.md
@.planning/phases/01-file-reading-optimization/01-01-SUMMARY.md
@server/projects.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update extractProjectDirectory to use byte-limited extraction</name>
  <files>server/projects.js</files>
  <action>
Refactor extractProjectDirectory() function (around line 449) to use the new extractCwdFromFirstBytes() function:

1. Keep the existing cache check at the start (projectDirectoryCache)
2. Keep the existing config lookup (loadProjectConfig -> originalPath)
3. Replace the current file reading logic that uses readline on full files with:
   - Loop through JSONL files as before
   - For each file, call extractCwdFromFirstBytes(filePath) instead of the current full-file streaming
   - If cwd found, cache it and return immediately
4. Add fallback chain when no cwd found in any file within 100KB:
   - Fallback 1: Check config (already exists)
   - Fallback 2: Decode project name (projectName.replace(/-/g, '/'))
   - Mark result with a metadata flag indicating fallback was used (add to cache entry)

Remove the following code that is no longer needed:
- The cwdCounts Map and related tracking logic
- The latestTimestamp/latestCwd tracking
- The MAX_ENTRIES_TO_CHECK constant (no longer entry-based)
- The complex "best cwd" selection logic (now we just take first found)

Keep the following:
- Cache mechanism (projectDirectoryCache)
- Config lookup (loadProjectConfig)
- Error handling for ENOENT
- Fallback to decoded project name

The function signature and return type must remain unchanged for backward compatibility.
  </action>
  <verify>
Run server and check project loading:
```bash
cd /workspace/projects/claudecodeui && npm run dev &
sleep 3
curl -s http://localhost:5001/api/projects | head -c 500
```
Projects should load without errors.
  </verify>
  <done>
- extractProjectDirectory() calls extractCwdFromFirstBytes() for each JSONL file
- No more line-counting or entry limits in extractProjectDirectory
- Fallback to folder name when cwd not found within 100KB
- Existing caching behavior preserved
- All projects still load correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify backward compatibility with skip patterns</name>
  <files>server/projects.js</files>
  <action>
Verify that the existing skip patterns and size limits still work correctly after the refactor:

1. Test SKIP_PROJECTS_PATTERN:
   - The getProjectSkipReason() function should still be called before extractProjectDirectory()
   - Verify in getProjects() that the skip check happens before cwd extraction

2. Test SKIP_LARGE_PROJECTS_MB:
   - The getCachedProjectSizeBytes() function should still work
   - Size calculation should not be affected by the byte-limited reading

3. Ensure getSessionMessages() is NOT affected:
   - This function (around line 1115) should still read full files for message content
   - Do NOT apply byte limits to getSessionMessages() - users need full message history

Review the code flow in getProjects():
- Line ~628: getProjectSkipReason() called BEFORE extractProjectDirectory() - this is correct
- Line ~635: extractProjectDirectory() called AFTER skip check - verify this order is preserved

No code changes needed if everything is correct. If skip check order is wrong, fix it.
  </action>
  <verify>
```bash
# Test skip pattern still works
cd /workspace/projects/claudecodeui
SKIP_PROJECTS_PATTERN="nonexistent" npm run dev &
sleep 3
curl -s http://localhost:5001/api/projects | grep -c "name"
# Should return project count (skip pattern shouldn't match anything)
pkill -f "node.*server"
```
  </verify>
  <done>
- SKIP_PROJECTS_PATTERN functionality preserved
- SKIP_LARGE_PROJECTS_MB functionality preserved
- getSessionMessages() reads full files (not byte-limited)
- Skip checks happen before expensive cwd extraction
  </done>
</task>

<task type="auto">
  <name>Task 3: Add incompleteMetadata flag to API response</name>
  <files>server/projects.js</files>
  <action>
Add a flag to indicate when project metadata came from fallback rather than actual file content:

1. Modify the cache entry in extractProjectDirectory() to include metadata:
   - Instead of just caching the path string, cache an object: { path: string, source: 'file' | 'config' | 'fallback' }
   - Update cache reads to extract the path from the object

2. Add incompleteMetadata field to project object in getProjects():
   - After calling extractProjectDirectory(), check if the cached source was 'fallback'
   - If so, add `incompleteMetadata: true` to the project object
   - This flag indicates the cwd was derived from folder name, not file content

3. Update the API response structure:
   - The incompleteMetadata flag should be optional (only present when true)
   - This is backward compatible - existing frontends will ignore the new field

Example project object with flag:
```javascript
{
  name: "my-project",
  path: "/decoded/path",
  displayName: "my-project",
  incompleteMetadata: true,  // Only present when cwd couldn't be read
  sessions: [...]
}
```

This satisfies READ-04 (graceful fallback) and COMPAT-01 (backward compatible API).
  </action>
  <verify>
```bash
cd /workspace/projects/claudecodeui && npm run dev &
sleep 3
# Check API response structure
curl -s http://localhost:5001/api/projects | python3 -c "import sys,json; d=json.load(sys.stdin); print('Fields:', list(d[0].keys()) if d else 'No projects')"
pkill -f "node.*server"
```
  </verify>
  <done>
- Cache stores source information (file/config/fallback)
- Projects with fallback cwd have incompleteMetadata: true
- API response structure unchanged (new field is additive)
- Frontend continues to work without changes
  </done>
</task>

</tasks>

<verification>
Full verification:
```bash
cd /workspace/projects/claudecodeui

# 1. Run existing tests
npm test

# 2. Start server and verify projects load
npm run dev &
sleep 3
curl -s http://localhost:5001/api/projects | head -c 1000

# 3. Verify a specific session still loads messages
# (replace with actual project/session IDs if available)
curl -s "http://localhost:5001/api/projects" | python3 -c "
import sys, json
data = json.load(sys.stdin)
if data and data[0].get('sessions'):
    print('First project:', data[0]['name'])
    print('Sessions:', len(data[0].get('sessions', [])))
    print('Has incompleteMetadata:', 'incompleteMetadata' in data[0])
"

pkill -f "node.*server"
```
</verification>

<success_criteria>
- extractProjectDirectory() uses extractCwdFromFirstBytes() (not full-file reading)
- Fallback to folder name when cwd not found in 100KB
- incompleteMetadata flag added when using fallback
- SKIP_PROJECTS_PATTERN still works
- SKIP_LARGE_PROJECTS_MB still works
- getSessionMessages() still reads full message content
- API response structure backward compatible
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-file-reading-optimization/01-02-SUMMARY.md`
</output>
