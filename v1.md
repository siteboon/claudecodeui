# Coolify Integration Plan for Claude Code UI

## Overview
Integrate Coolify with Claude Code UI to enable:
- Viewing all Coolify projects/applications in the sidebar
- Coding on Coolify applications with Claude Code
- One-click deploy (auto-commit, push, trigger Coolify deployment)

## Coolify API Summary

**Hierarchy:** Projects → Environments → Applications

**Key Endpoints:**
| Endpoint | Method | Description |
|----------|--------|-------------|
| `/projects` | GET | List all projects with embedded environments |
| `/applications` | GET | List all applications with git repo info |
| `/applications/{uuid}` | GET | Get single application details |
| `/deploy?uuid={uuid}` | GET/POST | Trigger deployment for application |

**Application Fields (relevant):**
- `uuid`, `name`, `status`, `fqdn`
- `git_repository`, `git_branch`, `git_commit_sha`
- `environment_id` (links to parent environment)

**Auth:** Bearer token via `Authorization` header

---

## Implementation Plan

### Phase 1: Backend API Routes

**File:** `server/routes/coolify.js` (new)

Create Express router with endpoints:

```
GET  /api/coolify/projects      → Fetch all projects with environments
GET  /api/coolify/applications  → Fetch all applications (with git info)
GET  /api/coolify/app/:uuid     → Get single application details
POST /api/coolify/clone         → Clone repo for a Coolify application
POST /api/coolify/deploy/:uuid  → Auto-commit, push, trigger Coolify deploy
GET  /api/coolify/status        → Check Coolify connection status
```

**Environment Variables:**
- `COOLIFY_URL` - Coolify instance URL (e.g., `https://coolify.example.com`)
- `COOLIFY_TOKEN` - API token from Coolify

**Key Implementation Details:**

1. **Proxy Pattern:** All Coolify API calls go through our backend to:
   - Avoid CORS issues
   - Keep API token secure (not exposed to frontend)
   - Add error handling and response transformation

2. **Deploy Endpoint Logic:**
   ```
   POST /api/coolify/deploy/:uuid
   1. Get local project path from request body
   2. Run: git add -A
   3. Run: git commit -m "Deploy via Claude Code UI"
   4. Run: git push
   5. Call Coolify API: GET /deploy?uuid={uuid}
   6. Return deployment UUID for status tracking
   ```

3. **Clone Endpoint Logic:**
   ```
   POST /api/coolify/clone
   Body: { appUuid, targetPath? }
   1. Fetch application details from Coolify
   2. Extract git_repository and git_branch
   3. Clone to targetPath (default: ~/work/{app-name})
   4. Register as Claude Code project via addProjectManually()
   5. Return project info
   ```

**File:** `server/index.js` (modify)

Add route registration:
```javascript
import coolifyRoutes from './routes/coolify.js';
app.use('/api/coolify', authenticateToken, coolifyRoutes);
```

---

### Phase 2: Frontend API Client

**File:** `src/utils/api.js` (modify)

Add `coolify` namespace:

```javascript
coolify: {
  status: () => authenticatedFetch('/api/coolify/status'),
  getProjects: () => authenticatedFetch('/api/coolify/projects'),
  getApplications: () => authenticatedFetch('/api/coolify/applications'),
  getApplication: (uuid) => authenticatedFetch(`/api/coolify/app/${uuid}`),
  clone: (appUuid, targetPath) => authenticatedFetch('/api/coolify/clone', {
    method: 'POST',
    body: JSON.stringify({ appUuid, targetPath }),
  }),
  deploy: (uuid, projectPath) => authenticatedFetch(`/api/coolify/deploy/${uuid}`, {
    method: 'POST',
    body: JSON.stringify({ projectPath }),
  }),
}
```

---

### Phase 3: UI Components

#### 3.1 Coolify Sidebar Section

**File:** `src/components/CoolifySidebar.jsx` (new)

Displays hierarchical view:
```
[Coolify Projects]
├── Project A
│   ├── Production
│   │   ├── api-backend (running) ✓
│   │   └── web-frontend (running) ✓
│   └── Staging
│       └── api-backend (stopped)
└── Project B
    └── Production
        └── main-app (deploying...)
```

**Features:**
- Collapsible project/environment tree
- Status indicators (running/stopped/deploying)
- Click application → opens in Claude Code (clones if needed)
- Badge showing if locally cloned

#### 3.2 Deploy Button Component

**File:** `src/components/CoolifyDeployButton.jsx` (new)

**Features:**
- Shows only when current project is linked to Coolify app
- Click triggers: commit → push → deploy
- Shows deployment progress/status
- Confirmation dialog before deploy

#### 3.3 Sidebar Integration

**File:** `src/components/Sidebar.jsx` (modify)

Options for integration:
1. **Tab-based:** Add "Coolify" tab alongside current project list
2. **Inline:** Show Coolify apps alongside local projects with badge

**Recommended:** Tab-based approach for cleaner separation

---

### Phase 4: Local-Coolify Project Linking

**Logic to match local projects with Coolify applications:**

1. When loading projects, fetch Coolify applications
2. For each local project, get its git remote URL: `git remote get-url origin`
3. Match against Coolify app's `git_repository` field
4. Store mapping: `{ localProjectName: coolifyAppUuid }`

**File:** `server/projects.js` (modify)

Add function to check Coolify linkage:
```javascript
async function getCoolifyLinkage(projectPath) {
  // Get git remote URL
  // Compare with Coolify applications
  // Return matching app UUID or null
}
```

---

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `server/routes/coolify.js` | CREATE | Backend API routes |
| `server/index.js` | MODIFY | Register coolify routes |
| `src/utils/api.js` | MODIFY | Add coolify API methods |
| `src/components/CoolifySidebar.jsx` | CREATE | Coolify project tree UI |
| `src/components/CoolifyDeployButton.jsx` | CREATE | Deploy button with auto-commit |
| `src/components/Sidebar.jsx` | MODIFY | Integrate Coolify section |
| `server/projects.js` | MODIFY | Add Coolify linkage detection |

---

## Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                        Claude Code UI                           │
├─────────────────────────────────────────────────────────────────┤
│  Sidebar                    │  Main Panel                       │
│  ┌───────────────────────┐  │  ┌─────────────────────────────┐  │
│  │ [Local Projects]      │  │  │                             │  │
│  │ - my-project          │  │  │    Claude Code Chat         │  │
│  │ - another-proj        │  │  │                             │  │
│  │                       │  │  │                             │  │
│  │ [Coolify Apps]        │  │  └─────────────────────────────┘  │
│  │ ▼ Project A           │  │  ┌─────────────────────────────┐  │
│  │   ▼ Production        │  │  │ [Deploy to Coolify]         │  │
│  │     • api ✓ (linked)  │  │  │ Commits: 3 ahead            │  │
│  │     • web             │  │  └─────────────────────────────┘  │
│  └───────────────────────┘  │                                   │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼ API Calls
         ┌──────────────────────┐
         │   Backend (Express)  │
         │  /api/coolify/*      │
         └──────────────────────┘
                    │
                    ▼ Proxied Requests
         ┌──────────────────────┐
         │    Coolify API       │
         │  COOLIFY_URL/api/v1  │
         └──────────────────────┘
```

---

## Environment Variables Required

```bash
COOLIFY_URL=https://your-coolify-instance.com
COOLIFY_TOKEN=your-api-token-from-coolify
```

---

## Phase 2 (Future)

- Create new Coolify applications from existing GitHub repos
- View deployment logs in UI
- Environment variables management
- Pull request preview deployments

---

## API Sources

- [Coolify API Reference](https://coolify.io/docs/api-reference/api/)
- [Coolify Applications Docs](https://coolify.io/docs/applications/)
- [GitHub Integration](https://coolify.io/docs/applications/ci-cd/github/integration)
- [GitHub PR #3921 - API Endpoints for GitHub App](https://github.com/coollabsio/coolify/pull/3921)
